name: Auto PR to main
on:
  push:
    branches:
      - bandit-brain-system
jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create or update PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const head = 'bandit-brain-system';
            const base = 'main';
            const title = 'Bandit Brain System: LinUCB core, Decision API, simulator+drift, BIS benchmark, CI';
            const body = [
              'This PR integrates the Bandit Brain System:',
              '- LinUCB core and persistence',
              '- DecisionService API (callable + optional REST)',
              '- Simulator with drift, headless plots and reports',
              '- BIS metrics/scoring and CI benchmark runner',
              '- Updated tests and documentation',
              '',
              'Artifacts: CI uploads BIS plots and bis_report.json.',
              'Threshold: BIS >= 0.90 in CI.',
            ].join('\\n');
            const existing = await github.rest.pulls.list({ owner, repo, state: 'open', head: `${owner}:${head}`, base });
            if (existing.data && existing.data.length > 0) {
              core.info(`PR already exists: ${existing.data[0].html_url}`);
            } else {
              const pr = await github.rest.pulls.create({ owner, repo, head, base, title, body });
              core.info(`Created PR: ${pr.data.html_url}`);
              await github.rest.issues.addLabels({ owner, repo, issue_number: pr.data.number, labels: ['automation', 'bandit-brain', 'ci'] });
            }
